version: '3'

vars:
  VERBOSE: '{{if or .CLI_VERBOSE .VERBOSE}}true{{else}}false{{end}}'
  VERBOSE_FLAG: '{{if eq .VERBOSE "true"}}--verbose{{end}}'

  EXTENSION_NAME: hadolint
  PUBLISHER: TobiasHochguertel

tasks:
  default:
    desc: List all available tasks
    cmds:
      - task --list

  d:
    desc: Debug task
    cmds:
      - echo "Debug task executed"
      - |
        echo "Verbose: {{.VERBOSE}}"
        echo "Verbose Flag: {{.VERBOSE_FLAG}}"

  install:
    desc: Install all dependencies
    cmds:
      - npm install
    sources:
      - package.json
      - client/package.json
      - server/package.json

  clean:
    desc: Clean build artifacts and dependencies
    cmds:
      - rm -rf node_modules client/node_modules server/node_modules
      - rm -rf client/out server/out
      - rm -rf *.vsix
      - rm -rf .vscode-test

  build:
    desc: Build the extension
    deps: [install]
    cmds:
      - npm run build
    sources:
      - client/src/**/*.ts
      - server/src/**/*.ts
      - tsconfig.json
      - client/tsconfig.json
      - server/tsconfig.json
    generates:
      - client/out/**/*.js
      - server/out/**/*.js

  watch:
    desc: Watch and rebuild on changes
    cmds:
      - npm run watch

  compile:
    desc: Compile TypeScript without bundling
    cmds:
      - npm run compile

  test:
    desc: Run all tests
    deps: [build]
    cmds:
      - npm test

  test:unit:
    desc: Run unit tests
    cmds:
      - echo "Unit tests not yet configured"

  test:integration:
    desc: Run integration tests
    cmds:
      - echo "Integration tests not yet configured"

  test:e2e:
    desc: Run E2E tests
    deps: [build]
    cmds:
      - sh ./scripts/e2e.sh

  lint:
    desc: Lint the codebase
    cmds:
      - npx tsc --noEmit
      - echo "✓ TypeScript compilation check passed"

  format:
    desc: Format code
    cmds:
      - npx prettier --write "**/*.{ts,json,md,yml}"

  package:
    desc: Package the extension
    deps: [build]
    cmds:
      - npx @vscode/vsce package
    generates:
      - '*.vsix'

  version:bump:
    desc: Bump version (usage - task version:bump -- <major|minor|patch>)
    cmds:
      - npm version {{.CLI_ARGS}} --no-git-tag-version
      - git add package.json package-lock.json
      - 'git commit -m "chore: bump version to $(node -p \"require(''./package.json'').version\")"'

  version:patch:
    desc: Bump patch version
    cmds:
      - task version:bump -- patch

  version:minor:
    desc: Bump minor version
    cmds:
      - task version:bump -- minor

  version:major:
    desc: Bump major version
    cmds:
      - task version:bump -- major

  publish:vscode:
    desc: Publish to VS Code Marketplace
    deps: [package]
    cmds:
      - npx @vscode/vsce publish
    preconditions:
      - sh: test -n "$VSCE_PAT"
        msg: 'VSCE_PAT environment variable must be set'

  publish:openvsx:
    desc: Publish to Open VSX Registry
    deps: [package]
    cmds:
      - npx ovsx publish *.vsix -p $OVSX_PAT
    preconditions:
      - sh: test -n "$OVSX_PAT"
        msg: 'OVSX_PAT environment variable must be set'

  publish:all:
    desc: Publish to both VS Code Marketplace and Open VSX
    deps: [publish:vscode, publish:openvsx]

  outdated:
    desc: Check for outdated dependencies
    cmds:
      - npm outdated || true
      - cd client && npm outdated || true
      - cd server && npm outdated || true

  update:deps:
    desc: Update dependencies to latest versions
    cmds:
      - npm update
      - cd client && npm update
      - cd server && npm update

  security:audit:
    desc: Run security audit
    cmds:
      - npm audit
      - cd client && npm audit
      - cd server && npm audit

  security:fix:
    desc: Fix security vulnerabilities
    cmds:
      - npm audit fix
      - cd client && npm audit fix
      - cd server && npm audit fix

  release:
    desc: Create a new release (version bump, tag, publish)
    cmds:
      - task version:bump -- {{.CLI_ARGS}}
      - git tag v$(node -p "require('./package.json').version")
      - git push origin main --tags
      - task publish:all

  ci:
    desc: Run CI checks
    cmds:
      - task lint
      - task build
      - task test

  dev:
    desc: Start development environment
    cmds:
      - task watch

  debug:
    desc: Launch extension in debug mode
    cmds:
      - code --extensionDevelopmentPath=$(pwd)

  # Local workflow testing with act
  # Configuration in .actrc for Colima compatibility
  act:install:
    desc: Install act (GitHub Actions local runner)
    cmds:
      - |
        if command -v act &> /dev/null; then
          echo "✓ act is already installed ($(act --version))"
        elif command -v brew &> /dev/null; then
          echo "Installing act via Homebrew..."
          brew install act
        else
          echo "Please install act manually from https://github.com/nektos/act"
          exit 1
        fi

  act:upgrade:
    desc: Upgrade act to the latest version
    cmds:
      - |
        if command -v brew &> /dev/null; then
          brew upgrade act
        else
          echo "Please upgrade act manually from https://github.com/nektos/act"
          exit 1
        fi

  act:pull:
    desc: Pre-pull Docker images for act (avoids auth issues)
    cmds:
      - docker pull --platform linux/amd64 catthehacker/ubuntu:act-latest
      - echo "✓ Images pulled successfully"

  act:list:
    desc: List available workflows
    cmds:
      - act {{.VERBOSE_FLAG}} -l

  act:ci:
    desc: Run CI workflow locally (run task act:pull first to cache images)
    deps: [act:pull]
    cmds:
      - act {{.VERBOSE_FLAG}} --pull=false -j lint -j test

  act:ci:lint:
    desc: Run CI lint job locally
    deps: [act:pull]
    cmds:
      - act {{.VERBOSE_FLAG}} --pull=false -j lint

  act:ci:test:
    desc: Run CI test job locally
    deps: [act:pull]
    cmds:
      - act {{.VERBOSE_FLAG}} --pull=false -j test

  act:codeql:
    desc: Run CodeQL workflow locally
    deps: [act:pull]
    cmds:
      - act {{.VERBOSE_FLAG}} --pull=false -W .github/workflows/codeql-analysis.yml

  act:dryrun:
    desc: Dry-run all workflows (shows what would run without Docker)
    cmds:
      - act {{.VERBOSE_FLAG}} -n
